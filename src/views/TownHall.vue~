<template>
	<div class="container">
		<div class="outside row">
			<div class="col-md-3">
				<h4>Trending</h4>
				<button @click="getCurrentUser">Current User</button>
				<p>Look at console for output</p>
			</div>
			
			<div class="col-12 col-md-9">
				<form method="POST" @submit.prevent="postPosts">
					<textarea
						class="form-control"
						v-model="post"
						placeholder="Thoughts?"
						style="height:130px"
						@keyup="minCharRequired"
						name="post">
					</textarea>
					
					<div class="row mt-2">
						<div class="col-6">
							<span v-if="charLeft < 300">
								<span style="color:red">{{charLeft}}</span>
							</span>
							<span v-else>
								<span style="color:green">{{charLeft}}</span>
							</span>
						</div>
						<div class="col-6 d-flex justify-content-end">
							<button class="btn btn-primary">Post</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</template>

<script>
import axios from 'axios';
import {toast} from 'bulma-toast';

export default{
	name: 'TownHall',
	data(){
		return {
			post: '',
			errors: [],
			success: [],
			timeline: [],

			user_id: '',
			
			// Character count of the textarea
			charLeft: 0,
		}
	},
	mounted(){
		document.title = 'Town Hall | Wlog'
	},
	created(){
		this.user = localStorage.getItem('username')
		console.log(localStorage.getItem('accessToken'))
		console.log(localStorage.getItem('refreshToken'))
	},
	methods: {
		/* 
		   * Normally, for every authenticated axios requests you need to put an Authorization header,
		   * Like, axios
		   			.post('url', {data}, {
						headers: {'Authorization': token}
					}),
		   but the function in /src/refresh_api.js handle the headers' request
		   * This made wrote a headers inside axios request optional, because that function already made global by utilizing it inside main.js
		*/

		getCurrentUser(){
			axios
				.get('/backdoor/api/user/')
				.then(response => {
					console.log(response.data.id)
					console.log(response.data.username)
				})
				.catch(error => {
					console.log(error.response)
				})
		},

		minCharRequired(){
			let left = this.post.length
			this.charLeft = left
			return this.charLeft
		},
	
		async postPosts(){
			this.errors = []
			this.success = []
			
			if(this.post === ''){
				this.errors.push('Post field can\'t be empty')
			}
			if(this.post.length < 300){
				this.errors.push('You need more than 300 characters!')
			}
			
			if(!this.errors.length){
				await axios
					.get('/backdoor/api/user/', {
						headers: {
							'Content-Type': 'application/json'
						}
					})
					.then(response => {
						this.user_id = response.data.id
					})
					.catch(error => {
						console.log(error.response)
					})

				const formData = {
					post: this.post,
					//username: this.user_id,
				}

				await axios
					.post('/backdoor/api/posts/', formData, {
						headers: {
							'Content-Type': 'application/json'
						}
					})
					.then(response => {
						console.log(response.data)
						if(response.data){
							toast({
								message: 'Your post has been successfully posted',
								type: 'is-success',
								dismissable: true,
								duration: 2000,
								position: 'top-center',
								animate: {
									in: 'fadeIn', out: 'fadeOut'
								},
							})
						}
						
					})
					.catch(error => {
						if(error.response){
							console.log(error)
							for(const property in error.response.data){
								this.errors.push(`${property}: ${error.response.data[property]}`)
							}
							console.log(JSON.stringify(error))
						} else if(error.request){
							//this.errors.push('Something went wrong!')
							console.log(JSON.stringify(error))
						} else {
							console.log(error.message)
						}
					})
			}
		}
	},
}
</script>

<style scoped>
.outside.row {
	padding: 100px 15px 50px 15px;
}
</style>
